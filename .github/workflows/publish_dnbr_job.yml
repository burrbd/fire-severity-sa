name: â˜ï¸ Manual - Publish dNBR Job to S3

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Job ID from previous action'
        required: true
        type: string

jobs:
  publish-dnbr-job:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_DEFAULT_REGION || 'ap-southeast-2' }}
    
    - name: Publish dNBR job to S3
      run: |
        echo "ğŸ”§ Using job ID: ${{ inputs.job_id }}"
        echo "â˜ï¸ Using S3 bucket: ${{ vars.AWS_S3_BUCKET_NAME }}"
        echo "ğŸŒ Using AWS region: ${{ vars.AWS_DEFAULT_REGION || 'ap-southeast-2' }}"
        
        # Publish data to S3
        python scripts/publish_dnbr_job.py \
          --job-id ${{ inputs.job_id }}
    
    - name: Output job information
      run: |
        echo "âœ… Publishing completed successfully!"
        echo "ğŸ“Š Job ID: ${{ inputs.job_id }}"
        echo "â˜ï¸ S3 Bucket: ${{ vars.AWS_S3_BUCKET_NAME }}"
        echo "ğŸŒ Region: ${{ vars.AWS_DEFAULT_REGION || 'ap-southeast-2' }}"
        echo ""
        echo "ğŸ’¡ The job data has been published to S3 and the database has been updated with the S3 URLs."
        echo "ğŸ”— You can now access the data via the S3 URLs stored in the job record."
